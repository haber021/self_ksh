<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Refund Receipt</title>
    <style>
        @page { size: 58mm auto; margin: 2mm; }
        html, body {
            margin: 0;
            padding: 0;
            font-family: "Courier New", monospace;
            background: #f5f5f5;
        }
        @media screen {
            body {
                width: 100%;
                max-width: 600px;
                margin: 0 auto;
                padding: 20px;
                background: #f5f5f5;
            }
        }
        .receipt-paper {
            width: 56mm;
            margin: 0 auto;
            padding: 2mm;
            font-size: 12pt;
            line-height: 1.45;
            color: #000;
            background: #fff;
        }
        @media screen {
            .receipt-paper {
                border: 2px dashed #333;
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            }
        }
        .rp-center { text-align: center; }
        .rp-title { 
            font-size: 13pt; 
            font-weight: bold; 
            margin-bottom: 2mm;
        }
        .rp-address {
            font-size: 10pt;
            margin-bottom: 1mm;
        }
        .rp-phone {
            font-size: 10pt;
            margin-bottom: 2mm;
        }
        .rp-separator {
            text-align: center;
            margin: 2mm 0;
            font-size: 10pt;
            letter-spacing: 1px;
        }
        .rp-receipt-type {
            text-align: center;
            font-size: 12pt;
            font-weight: bold;
            margin: 2mm 0;
            text-transform: uppercase;
        }
        .rp-line {
            display: flex;
            justify-content: space-between;
            margin: 1.5mm 0;
            font-size: 11pt;
        }
        .rp-line-label {
            font-weight: bold;
        }
        .rp-section {
            margin: 2mm 0;
        }
        .rp-section-title {
            font-weight: bold;
            font-size: 11pt;
            margin: 2mm 0 1mm 0;
            text-transform: uppercase;
        }
        .rp-items-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 11pt;
            margin: 2mm 0 1mm 0;
            padding-bottom: 1mm;
            border-bottom: 1px solid #000;
        }
        .rp-item-row {
            display: flex;
            justify-content: space-between;
            margin: 1mm 0;
            font-size: 11pt;
        }
        .rp-item-description {
            flex: 1;
            text-align: left;
        }
        .rp-item-price {
            text-align: right;
            min-width: 30%;
        }
        .rp-total-section {
            margin-top: 2mm;
        }
        .rp-total-row {
            display: flex;
            justify-content: space-between;
            margin: 1.5mm 0;
            font-size: 11pt;
        }
        .rp-total-label {
            font-weight: bold;
        }
        .rp-total-value {
            font-weight: bold;
            text-align: right;
        }
        .rp-grand-total {
            font-size: 13pt;
            font-weight: bold;
            margin-top: 2mm;
            padding-top: 2mm;
            border-top: 2px solid #000;
            color: #d00;
        }
        .rp-subline {
            font-size: 10pt;
            margin-top: 1mm;
            line-height: 1.3;
        }
        .rp-thanks {
            text-align: center;
            font-size: 11pt;
            font-weight: bold;
            margin-top: 3mm;
            margin-bottom: 2mm;
            text-transform: uppercase;
        }
        .print-controls {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }
        #printBtn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            margin-right: 10px;
        }
        #printBtn:hover {
            background-color: #0056b3;
        }
        #closeBtn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
        }
        #closeBtn:hover {
            background-color: #545b62;
        }

        @media print {
            @page { size: 58mm auto; margin: 2mm; }
            .receipt-paper { width: 56mm !important; }
            .print-controls { display: none !important; }
        }
    </style>
</head>

<body>
    <div class="print-controls">
        <button id="printBtn" onclick="handlePrintReceipt()">üñ®Ô∏è Print Receipt</button>
        <button id="closeBtn" onclick="closeReceiptWindow()">‚úï Close</button>
    </div>
<div class="receipt-paper">

    <!-- Header Section -->
    <div class="rp-center">
        <div class="rp-title">{{ shop_name|default:"COOPERATIVE STORE" }}</div>
        <div class="rp-address">{{ shop_address|default:"Address: Lorem Ipsum, 23-10" }}</div>
        <div class="rp-phone">{{ shop_phone|default:"Telp. 11223344" }}</div>
    </div>

    <div class="rp-separator">******************************</div>

    <!-- Receipt Type -->
    <div class="rp-receipt-type">REFUND RECEIPT</div>

    <div class="rp-separator">******************************</div>

    <!-- Transaction Info -->
    <div class="rp-section">
        <div class="rp-line">
            <span class="rp-line-label">Original Txn:</span>
            <span>#{{ transaction.transaction_number }}</span>
        </div>
        <div class="rp-line">
            <span class="rp-line-label">Refund Date:</span>
            <span>{{ refund_date|date:"m/d/Y H:i" }}</span>
        </div>
    </div>

    <!-- Member Info -->
    {% if member %}
    <div class="rp-separator">******************************</div>
    <div class="rp-section">
        <div class="rp-line">
            <span class="rp-line-label">Member:</span>
            <span>{{ member.full_name }}</span>
        </div>
        {% if member.member_id %}
        <div class="rp-line">
            <span class="rp-line-label">Member ID:</span>
            <span>{{ member.member_id }}</span>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Items -->
    <div class="rp-separator">******************************</div>
    <div class="rp-items-header">
        <span class="rp-item-description">Item</span>
        <span class="rp-item-price">Amount</span>
    </div>

    {% for item in transaction.items.all %}
    <div class="rp-item-row">
        <span class="rp-item-description">{% if item.quantity > 1 %}{{ item.product_name }} (x{{ item.quantity }}){% else %}{{ item.product_name }}{% endif %}</span>
        <span class="rp-item-price">‚Ç±{{ item.total_price|floatformat:2 }}</span>
    </div>
    {% endfor %}

    <!-- Refund Method -->
    <div class="rp-separator">******************************</div>
    <div class="rp-section">
        <div class="rp-section-title">REFUND METHOD</div>
        
        {% if show_balance_refund %}
            <div class="rp-line">
                <span class="rp-line-label">Method:</span>
                <span>Refunded to Balance</span>
            </div>
            <div class="rp-line">
                <span class="rp-line-label">Balance Before:</span>
                <span>‚Ç±{{ balance_before|floatformat:2 }}</span>
            </div>
            <div class="rp-line">
                <span class="rp-line-label">Balance After:</span>
                <span>‚Ç±{{ balance_after|floatformat:2 }}</span>
            </div>
        {% elif show_utang_refund %}
            <div class="rp-line">
                <span class="rp-line-label">Method:</span>
                <span>Reduced from Utang</span>
            </div>
            <div class="rp-line">
                <span class="rp-line-label">Utang Before:</span>
                <span>‚Ç±{{ utang_before|floatformat:2 }}</span>
            </div>
            <div class="rp-line">
                <span class="rp-line-label">Utang After:</span>
                <span>‚Ç±{{ utang_after|floatformat:2 }}</span>
            </div>
        {% elif show_cash_refund %}
            <div class="rp-line">
                <span class="rp-line-label">Method:</span>
                <span>Cash Refund</span>
            </div>
        {% endif %}
    </div>

    <!-- Reason -->
    {% if refund_reason %}
    <div class="rp-separator">******************************</div>
    <div class="rp-section">
        <div class="rp-line">
            <span class="rp-line-label">Reason:</span>
        </div>
        <div class="rp-subline">{{ refund_reason }}</div>
    </div>
    {% endif %}

    <div class="rp-separator">******************************</div>

    <!-- Footer -->
    <div class="rp-thanks">THANK YOU!</div>

</div>
<script type="text/javascript">
    // Build complete receipt HTML with CSS for thermal printing (similar to kiosk.html)
    function buildReceiptHtml() {
        const receiptPaper = document.querySelector('.receipt-paper');
        if (!receiptPaper) {
            console.error('Receipt paper element not found');
            return null;
        }
        
        // Ensure the element is visible when capturing
        const wasHidden = receiptPaper.style.display === 'none';
        if (wasHidden) receiptPaper.style.display = 'block';
        
        const receiptContent = receiptPaper.outerHTML;
        
        // Debug: Check if content was captured
        if (!receiptContent || receiptContent.length < 100) {
            console.error('Receipt content too short or empty:', receiptContent);
        }
        
        if (wasHidden) receiptPaper.style.display = 'none';
        const css = `
            <style>
                @page { 
                    size: 58mm auto; 
                    margin: 2mm; 
                }
                @media print {
                    @page { 
                        size: 58mm auto; 
                        margin: 2mm; 
                    }
                }
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                body {
                    visibility: visible !important;
                }
                body .receipt-paper {
                    display: block !important;
                    visibility: visible !important;
                }
                body .receipt-paper > * {
                    visibility: visible !important;
                }
                html, body { 
                    padding: 0; 
                    margin: 0;
                    font-family: "Courier New", monospace;
                    background: white;
                    width: 100%;
                    min-width: 300px;
                }
                @media print {
                    html, body {
                        width: 58mm !important;
                    }
                }
                .receipt-paper { 
                    font-family: "Courier New", monospace; 
                    font-size: 12pt; 
                    line-height: 1.45; 
                    width: 56mm; 
                    max-width: 56mm; 
                    margin: 0 auto; 
                    padding: 2mm;
                    color: #000 !important;
                    display: block !important;
                    visibility: visible !important;
                    min-width: 200px;
                }
                @media print {
                    .receipt-paper {
                        width: 56mm !important;
                        max-width: 56mm !important;
                        min-width: 56mm !important;
                    }
                }
                .receipt-paper * { 
                    color: #000 !important; 
                    background: transparent !important;
                }
                .receipt-paper .rp-center { text-align: center; }
                .receipt-paper .rp-title { 
                    font-size: 13pt; 
                    font-weight: bold; 
                    margin-bottom: 2mm;
                    color: #000 !important;
                }
                .receipt-paper .rp-address {
                    font-size: 10pt;
                    margin-bottom: 1mm;
                    color: #000 !important;
                }
                .receipt-paper .rp-phone {
                    font-size: 10pt;
                    margin-bottom: 2mm;
                    color: #000 !important;
                }
                .receipt-paper .rp-separator {
                    text-align: center;
                    margin: 2mm 0;
                    font-size: 10pt;
                    letter-spacing: 1px;
                    color: #000 !important;
                    display: block !important;
                    visibility: visible !important;
                }
                .receipt-paper .rp-receipt-type {
                    text-align: center;
                    font-size: 12pt;
                    font-weight: bold;
                    margin: 2mm 0;
                    text-transform: uppercase;
                    color: #000 !important;
                }
                .receipt-paper .rp-line {
                    display: flex !important;
                    justify-content: space-between;
                    align-items: baseline;
                    width: 100%;
                    margin: 1.5mm 0;
                    font-size: 11pt;
                    color: #000 !important;
                }
                .receipt-paper .rp-line span:first-child {
                    flex: 1;
                    text-align: left;
                    padding-right: 2mm;
                    word-wrap: break-word;
                }
                .receipt-paper .rp-line span:last-child {
                    flex-shrink: 0;
                    text-align: right;
                    white-space: nowrap;
                }
                .receipt-paper .rp-line-label {
                    font-weight: bold;
                    color: #000 !important;
                }
                .receipt-paper .rp-section {
                    margin: 2mm 0;
                }
                .receipt-paper .rp-section-title {
                    font-weight: bold;
                    font-size: 11pt;
                    margin: 2mm 0 1mm 0;
                    text-transform: uppercase;
                    color: #000 !important;
                }
                .receipt-paper .rp-items-header {
                    display: flex !important;
                    justify-content: space-between;
                    font-weight: bold;
                    font-size: 11pt;
                    margin: 2mm 0 1mm 0;
                    padding-bottom: 1mm;
                    border-bottom: 1px solid #000;
                    color: #000 !important;
                }
                .receipt-paper .rp-item-row {
                    display: flex !important;
                    justify-content: space-between;
                    align-items: baseline;
                    width: 100%;
                    margin: 1mm 0;
                    font-size: 11pt;
                    color: #000 !important;
                }
                .receipt-paper .rp-item-description {
                    flex: 1;
                    text-align: left;
                    color: #000 !important;
                }
                .receipt-paper .rp-item-price {
                    text-align: right;
                    min-width: 30%;
                    color: #000 !important;
                }
                .receipt-paper .rp-subline {
                    font-size: 10pt;
                    margin-top: 1mm;
                    line-height: 1.3;
                    color: #000 !important;
                }
                .receipt-paper .rp-thanks {
                    text-align: center;
                    font-size: 11pt;
                    font-weight: bold;
                    margin-top: 3mm;
                    margin-bottom: 2mm;
                    text-transform: uppercase;
                    color: #000 !important;
                }
                .receipt-paper .rp-section {
                    display: block !important;
                    visibility: visible !important;
                }
                .receipt-paper .rp-center {
                    display: block !important;
                    visibility: visible !important;
                }
                @media print {
                    html, body {
                        width: 58mm !important;
                    }
                    .receipt-paper {
                        width: 56mm !important;
                        max-width: 56mm !important;
                    }
                }
            </style>
        `;
        return `<!doctype html><html><head><meta charset="utf-8"><title>Refund Receipt</title>${css}</head><body>${receiptContent}</body></html>`;
    }

    // Open receipt in new window with print controls (similar to kiosk.html printReceipt)
    function openReceiptInNewWindow() {
        const receiptHtml = buildReceiptHtml();
        
        if (!receiptHtml) {
            alert('Error: Could not generate receipt. Please try again.');
            return;
        }
        
        // Try to open print window (similar to kiosk.html)
        const printWin = window.open('', 'REFUND_RECEIPT_PRINT', 'width=420,height=600,scrollbars=yes');
        
        if (!printWin) {
            // Popup blocked - fall back to in-page printing
            console.warn('Popup blocked. Using in-page print...');
            setTimeout(() => {
                try { 
                    window.print(); 
                } catch (e) {
                    console.error('Print failed:', e);
                }
            }, 100);
            return;
        }
        
        // Set window name for detection
        try {
            printWin.name = 'REFUND_RECEIPT_PRINT';
        } catch (e) {
            // Ignore if we can't set name
        }
        
        // No print button - just auto-print directly
        let fullReceiptHtml = receiptHtml;
        
        // Add script before closing body tag for auto-print
        fullReceiptHtml = fullReceiptHtml.replace(
            /<\/body>/i,
            `<script>
                // Auto-print when page loads
                window.addEventListener('load', function() {
                    // Ensure receipt content is visible
                    const receiptPaper = document.querySelector('.receipt-paper');
                    if (receiptPaper) {
                        receiptPaper.style.display = 'block';
                        receiptPaper.style.visibility = 'visible';
                    }
                    // Auto-trigger print dialog
                    setTimeout(function() {
                        window.print();
                    }, 300);
                });
                
                // Close window after printing and notify parent
                window.addEventListener('afterprint', function() {
                    // Notify parent window that print is completed
                    try {
                        if (window.opener && !window.opener.closed) {
                            window.opener.postMessage('REFUND_RECEIPT_PRINTED', '*');
                        }
                    } catch (e) {
                        console.log('Could not notify parent window');
                    }
                    setTimeout(function() {
                        window.close();
                    }, 100);
                });
                
                // Notify parent when window is about to close
                window.addEventListener('beforeunload', function() {
                    try {
                        if (window.opener && !window.opener.closed) {
                            window.opener.postMessage('REFUND_RECEIPT_CLOSED', '*');
                        }
                    } catch (e) {
                        // Ignore if can't send message
                    }
                });
                
                // Handle keyboard shortcuts
                document.addEventListener('keydown', function(e) {
                    // Ctrl+P or Cmd+P to print
                    if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                        e.preventDefault();
                        window.print();
                    }
                    // Escape to close
                    if (e.key === 'Escape') {
                        // Notify parent before closing
                        try {
                            if (window.opener && !window.opener.closed) {
                                window.opener.postMessage('REFUND_RECEIPT_CLOSED', '*');
                            }
                        } catch (e) {
                            // Ignore
                        }
                        window.close();
                    }
                });
            <\/script></body>`
        );

        // Write receipt HTML to print window
        printWin.document.open();
        printWin.document.write(fullReceiptHtml);
        printWin.document.close();
        
        // Function to trigger print dialog
        const triggerPrint = () => {
            try {
                printWin.focus();
                // Longer delay to ensure content is fully rendered and visible
                setTimeout(() => {
                    try {
                        // Ensure content is visible before printing
                        const receiptPaper = printWin.document.querySelector('.receipt-paper');
                        if (receiptPaper) {
                            receiptPaper.style.display = 'block';
                            receiptPaper.style.visibility = 'visible';
                        }
                        printWin.print();
                    } catch (e) {
                        console.error('Print error:', e);
                    }
                }, 300);
            } catch (e) {
                console.error('Focus error:', e);
            }
        };

        // Wait for content to load, then trigger print
        const checkAndPrint = () => {
            if (printWin.document && printWin.document.readyState === 'complete') {
                // Additional check to ensure content is there
                const hasContent = printWin.document.querySelector('.receipt-paper');
                if (hasContent) {
                    triggerPrint();
                } else {
                    // Retry after a bit more time
                    setTimeout(checkAndPrint, 200);
                }
            } else {
                setTimeout(checkAndPrint, 100);
            }
        };

        if (printWin.document.readyState === 'complete') {
            checkAndPrint();
        } else {
            printWin.onload = function() {
                checkAndPrint();
            };
        }
        
        // Fallback: if onload doesn't fire, try after a delay
        setTimeout(() => {
            checkAndPrint();
        }, 1000);
    }

    // Function to handle print receipt (either in new window or direct print)
    function handlePrintReceipt() {
        // Always try to open in new window for better print experience
        openReceiptInNewWindow();
    }

    // Function to close receipt window and notify parent
    function closeReceiptWindow() {
        // Notify parent window that receipt is being closed
        try {
            if (window.opener && !window.opener.closed) {
                window.opener.postMessage('REFUND_RECEIPT_CLOSED', '*');
            }
        } catch (e) {
            // Ignore if can't send message
        }
        window.close();
    }

    // Auto-trigger print when page loads (if in popup opened via openReceiptInNewWindow)
    window.addEventListener('load', function() {
        // If we're in a popup window (opened via openReceiptInNewWindow), auto-trigger print
        // Check if window.name indicates we're in a print window
        if (window.name === 'REFUND_RECEIPT_PRINT' || window.opener) {
            setTimeout(() => {
                try {
                    window.print();
                } catch (e) {
                    console.error('Print failed:', e);
                }
            }, 300);
        }
    });

    // Auto-close window after printing is complete
    window.addEventListener('afterprint', function() {
        // Notify parent window that print is completed
        try {
            if (window.opener && !window.opener.closed) {
                window.opener.postMessage('REFUND_RECEIPT_PRINTED', '*');
            }
        } catch (e) {
            console.log('Could not notify parent window');
        }
        // Close window after print is complete
        setTimeout(function() {
            window.close();
        }, 500);
    });
    
    // Handle keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+P or Cmd+P to print
        if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
            e.preventDefault();
            window.print();
        }
        // Escape to close
        if (e.key === 'Escape') {
            closeReceiptWindow();
        }
    });
</script>
</body>
</html>
