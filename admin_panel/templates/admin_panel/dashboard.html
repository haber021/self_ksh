<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Super Admin Console | Cooperative Store</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --dark: #0f172a;
      --brand: #1f7a3a;
      --accent: #0b5f3a;
      --muted: #94a3b8;
      --panel: #ffffff;
      --gradient: linear-gradient(135deg, #1f7a3a 0%, #0b5f3a 40%, #0d9488 100%);
    }

    body {
      background: #f1f5f9;
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', sans-serif;
    }

    .super-nav {
      background: var(--dark);
      color: #fff;
      box-shadow: 0 10px 30px rgba(15,23,42,0.4);
    }

    .nav-pill {
      border-radius: 999px;
      padding: 8px 18px;
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
    }

    .nav-pill.active, .nav-pill:hover {
      background: rgba(255,255,255,0.15);
      color: #fff;
    }

    .hero-card {
      background: var(--gradient);
      color: #fff;
      border-radius: 24px;
      padding: 32px;
      box-shadow: 0 25px 55px rgba(15,23,42,0.35);
    }

    .hero-metric {
      background: rgba(255,255,255,0.18);
      border-radius: 16px;
      padding: 16px 20px;
      min-width: 160px;
    }

    .stat-card {
      border: none;
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 18px 36px rgba(15,23,42,0.08);
      background: var(--panel);
      height: 100%;
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      color: #fff;
    }

    .stat-title {
      color: var(--muted);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .chart-card {
      border-radius: 20px;
      padding: 20px;
      background: var(--panel);
      box-shadow: 0 15px 30px rgba(15,23,42,0.07);
      height: 100%;
      overflow: hidden;
      position: relative;
      z-index: 0;
      display: flex;
      flex-direction: column;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .chart-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(15,23,42,0.12) !important;
    }

    .table-card {
      position: relative;
      z-index: 5;
      overflow: visible;
    }

    .chart-wrapper {
      position: relative;
      width: 100%;
      overflow: hidden;
      padding: 10px 0;
    }

    .chart-wrapper canvas {
      max-width: 100%;
      display: block;
    }

    .chart-card.expanded {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      height: 100vh;
      z-index: 9999;
      border-radius: 0;
      padding: 30px;
      overflow-y: auto;
      background: var(--panel);
    }

    .chart-card.expanded .chart-wrapper {
      height: calc(100vh - 150px) !important;
      max-height: none !important;
    }

    .expand-chart-btn {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .expand-chart-btn:hover {
      transform: scale(1.1);
    }

    .table-card table {
      font-size: 0.9rem;
    }

    .table-card thead {
      color: var(--muted);
      text-transform: uppercase;
      font-size: 0.75rem;
    }

    .chips {
      display: inline-flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      background: #e2e8f0;
      color: #0f172a;
      border-radius: 999px;
      padding: 4px 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    #paymentMixCenter {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    #paymentMixSummary {
      border-top: 1px solid rgba(148, 163, 184, 0.2);
    }

    #paymentMethodBreakdown .col-6 > div {
      transition: all 0.2s ease;
    }

    #paymentMethodBreakdown .col-6 > div:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    #salesTrendStats .col-6,
    #salesTrendStats .col-md-3 {
      transition: transform 0.2s ease;
    }

    #salesTrendStats .col-6:hover,
    #salesTrendStats .col-md-3:hover {
      transform: translateY(-2px);
    }

    #salesTrendStats .bg-light {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.05);
      transition: all 0.2s ease;
    }

    #salesTrendStats .bg-light:hover {
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.1);
    }
  </style>
</head>
<body>
  <nav class="navbar super-nav navbar-expand-lg py-3">
    <div class="container-fluid px-4">
      <a class="navbar-brand fw-bold text-white" href="{% url 'dashboard' %}">
        <i class="bi bi-shield-lock-fill me-2"></i>Super Admin
      </a>
      <form method="post" action="{% url 'admin_logout' %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger rounded-pill px-4">
          <i class="bi bi-box-arrow-right me-1"></i>Logout
        </button>
      </form>
    </div>
  </nav>

  <main class="container-fluid px-4 py-5">
    <section class="hero-card mb-4">
      <div class="row align-items-center g-4">
        <div class="col-lg-8">
          <p class="mb-2 text-uppercase fw-semibold" style="letter-spacing:0.2em;">Command Center</p>
          <h1 class="fw-bold mb-2">Hello, {{ user_display_name|default:"Admin" }} ðŸ‘‹</h1>
          <p class="mb-4 lead text-white-50">
            Monitor real-time performance of the cooperative store. Track sales, members, inventory and credit standing from a single super admin console.
          </p>
          <div class="chips">
            <span class="chip"><i class="bi bi-lightning-charge-fill me-1"></i> Today: â‚±{{ today_revenue|floatformat:2 }}</span>
            <span class="chip"><i class="bi bi-receipt-cutoff me-1"></i> {{ today_transactions }} transactions</span>
            <span class="chip"><i class="bi bi-graph-up-arrow me-1"></i> Total â‚±{{ total_revenue|floatformat:2 }}</span>
          </div>
        </div>
        <div class="col-lg-4 d-flex gap-3 justify-content-lg-end flex-wrap">
          <div class="hero-metric">
            <small class="text-uppercase text-white-50">Members</small>
            <h3 class="mb-0">{{ total_members }}</h3>
            <small>{{ members_with_utang }} with utang</small>
          </div>
          <div class="hero-metric">
            <small class="text-uppercase text-white-50">Patronage</small>
            <h3 class="mb-0">â‚±{{ total_patronage|floatformat:2 }}</h3>
            <small>Lifetime</small>
          </div>
        </div>
      </div>
    </section>

    <div class="d-flex gap-2 flex-wrap mb-4">
      <a href="{% url 'dashboard' %}" class="btn btn-success rounded-pill px-4 active"><i class="bi bi-speedometer2 me-1"></i> Dashboard</a>
      <a href="{% url 'inventory_management' %}" class="btn btn-outline-success rounded-pill px-4"><i class="bi bi-box-seam me-1"></i> Inventory</a>
      <a href="{% url 'member_management' %}" class="btn btn-outline-success rounded-pill px-4"><i class="bi bi-people-fill me-1"></i> Members</a>
      <a href="{% url 'transaction_history' %}" class="btn btn-outline-success rounded-pill px-4"><i class="bi bi-receipt me-1"></i> Transactions</a>
      <a href="{% url 'patronage_settings' %}" class="btn btn-outline-success rounded-pill px-4"><i class="bi bi-percent me-1"></i> Patronage</a>
      <a href="{% url 'process_refund' %}" class="btn btn-outline-warning rounded-pill px-4"><i class="bi bi-arrow-counterclockwise me-1"></i> Refunds</a>
      <button type="button" class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#refillBalanceModal">
        <i class="bi bi-wallet2 me-1"></i> Refill Card Balance
      </button>
    </div>

    <section class="row g-4 mb-4">
      <div class="col-xl-3 col-md-6">
        <div class="stat-card">
          <div class="d-flex align-items-center gap-3">
            <div class="stat-icon" style="background:#1f7a3a;"><i class="bi bi-cash-stack"></i></div>
            <div>
              <div class="stat-title">Total Revenue</div>
              <h3 class="mb-0">â‚±{{ total_revenue|floatformat:2 }}</h3>
              <small class="text-success">+ Today â‚±{{ today_revenue|floatformat:2 }}</small>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6">
        <div class="stat-card">
          <div class="d-flex align-items-center gap-3">
            <div class="stat-icon" style="background:#0d9488;"><i class="bi bi-bar-chart-line"></i></div>
            <div>
              <div class="stat-title">Transactions</div>
              <h3 class="mb-0">{{ total_transactions }}</h3>
              <small class="text-muted">{{ today_transactions }} today</small>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6">
        <div class="stat-card">
          <div class="d-flex align-items-center gap-3">
            <div class="stat-icon" style="background:#f97316;"><i class="bi bi-credit-card-2-front"></i></div>
            <div>
              <div class="stat-title">Outstanding Utang</div>
              <h3 class="mb-0">â‚±{{ total_utang|floatformat:2 }}</h3>
              <small class="text-muted">{{ members_with_utang }} members</small>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6">
        <div class="stat-card">
          <div class="d-flex align-items-center gap-3">
            <div class="stat-icon" style="background:#6366f1;"><i class="bi bi-boxes"></i></div>
            <div>
              <div class="stat-title">Inventory Alerts</div>
              <h3 class="mb-0">{{ low_stock_products }}</h3>
              <small class="text-danger">{{ out_of_stock_products }} out of stock</small>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6">
        <div class="stat-card">
          <div class="d-flex align-items-center gap-3">
            <div class="stat-icon" style="background:#ef4444;"><i class="bi bi-arrow-counterclockwise"></i></div>
            <div>
              <div class="stat-title">Total Refunds</div>
              <h3 class="mb-0">{{ total_refunds }}</h3>
              <small class="text-danger">â‚±{{ total_refund_amount|floatformat:2 }} total</small>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6">
        <div class="stat-card">
          <div class="d-flex align-items-center gap-3">
            <div class="stat-icon" style="background:#f59e0b;"><i class="bi bi-arrow-counterclockwise"></i></div>
            <div>
              <div class="stat-title">Today's Refunds</div>
              <h3 class="mb-0">{{ today_refunds }}</h3>
              <small class="text-warning">â‚±{{ today_refund_amount|floatformat:2 }} today</small>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="row g-4 mb-4">
      <div class="col-xl-8">
        <div class="chart-card" id="salesTrendCard">
          <div class="d-flex justify-content-between align-items-start mb-4">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center gap-2 mb-2">
                <div class="stat-icon" style="background: linear-gradient(135deg, #1f7a3a 0%, #0b5f3a 100%); width: 40px; height: 40px; font-size: 1.1rem;">
                  <i class="bi bi-graph-up-arrow"></i>
                </div>
                <div>
                  <h5 class="mb-0 fw-bold">Sales Trend (14 days)</h5>
                  <small class="text-muted">Revenue snapshot for the last two weeks</small>
                </div>
              </div>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-success-subtle text-success rounded-pill px-3 py-2">
                <i class="bi bi-circle-fill me-1" style="font-size: 0.5rem; animation: pulse 2s infinite;"></i>Live
              </span>
              <button type="button" class="btn btn-sm btn-outline-success rounded-pill expand-chart-btn" id="expandSalesChartBtn" title="Expand chart">
                <i class="bi bi-arrows-fullscreen" id="expandSalesChartIcon"></i>
              </button>
            </div>
          </div>
          
          <!-- Summary Statistics -->
          <div class="row g-3 mb-4" id="salesTrendStats">
            <div class="col-6 col-md-3">
              <div class="bg-light rounded-3 p-3 text-center border-start border-4 border-success">
                <div class="text-muted small mb-1" style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em;">Total Revenue</div>
                <div class="h5 mb-0 fw-bold text-success" id="total14DayRevenue">â‚±0.00</div>
                <div class="text-muted" style="font-size: 0.75rem;">14 days</div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="bg-light rounded-3 p-3 text-center border-start border-4 border-primary">
                <div class="text-muted small mb-1" style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em;">Daily Average</div>
                <div class="h5 mb-0 fw-bold text-primary" id="avgDailyRevenue">â‚±0.00</div>
                <div class="text-muted" style="font-size: 0.75rem;">per day</div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="bg-light rounded-3 p-3 text-center border-start border-4 border-warning">
                <div class="text-muted small mb-1" style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em;">Peak Day</div>
                <div class="h6 mb-0 fw-bold text-warning" id="peakDayAmount">â‚±0.00</div>
                <div class="text-muted" style="font-size: 0.7rem;" id="peakDayLabel">-</div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="bg-light rounded-3 p-3 text-center border-start border-4" id="growthCard" style="border-color: #10b981;">
                <div class="text-muted small mb-1" style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em;">Growth</div>
                <div class="h5 mb-0 fw-bold" id="growthPercentage" style="color: #10b981;">0%</div>
                <div class="text-muted" style="font-size: 0.7rem;" id="growthLabel">Week over week</div>
              </div>
            </div>
          </div>
          
          <div class="chart-wrapper" id="salesTrendWrapper" style="height:280px; max-height:280px;">
            <canvas id="salesTrendChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col-xl-4">
        <div class="chart-card mb-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="mb-0 d-flex align-items-center">
                <i class="bi bi-pie-chart-fill me-2 text-primary"></i>Payment Mix
              </h5>
              <small class="text-muted">Distribution by payment method</small>
            </div>
            <span class="badge bg-primary-subtle text-primary rounded-pill">
              <i class="bi bi-activity me-1"></i>Live
            </span>
          </div>
          <div class="chart-wrapper position-relative" style="height:220px; max-height:220px;">
            <canvas id="paymentMixChart"></canvas>
            <div id="paymentMixCenter" class="position-absolute top-50 start-50 translate-middle text-center" style="pointer-events: none; z-index: 10;">
              <div class="fw-bold text-primary" style="font-size: 1.5rem;" id="paymentMixTotal">â‚±0.00</div>
              <small class="text-muted d-block">Total</small>
            </div>
          </div>
          <div id="paymentMixSummary" class="mt-3 pt-3 border-top">
            <div class="row g-2" id="paymentMethodBreakdown">
              <!-- Payment method breakdown will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="row g-4 mb-4">
      <div class="col-xl-8">
        <div class="chart-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="mb-0">Refund Trend (14 days)</h5>
              <small class="text-muted">Refund activity and amounts over the last two weeks</small>
            </div>
            <a href="{% url 'process_refund' %}" class="btn btn-sm btn-outline-warning rounded-pill">
              <i class="bi bi-arrow-counterclockwise me-1"></i>Process Refund
            </a>
          </div>
          <div class="chart-wrapper" style="height:240px; max-height:240px;">
            <canvas id="refundTrendChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col-xl-4">
        <div class="chart-card table-card h-100">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Recent Refunds</h5>
            <a href="{% url 'process_refund' %}" class="btn btn-sm btn-outline-secondary rounded-pill">View all</a>
          </div>
          <div class="table-responsive" style="max-height: 240px; overflow-y: auto;">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Transaction #</th>
                  <th>Member</th>
                  <th>Amount</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                {% for refund in recent_refunds %}
                <tr>
                  <td class="fw-semibold">{{ refund.transaction_number }}</td>
                  <td>{{ refund.member.full_name|default:"Guest" }}</td>
                  <td class="fw-semibold text-danger">â‚±{{ refund.total_amount|floatformat:2 }}</td>
                  <td><small>{{ refund.updated_at|date:"M d, Y H:i" }}</small></td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-center text-muted py-4">No refunds yet</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="row g-4 mb-4">
      <div class="col-xl-4">
        <div class="chart-card table-card h-100">
          <h5 class="mb-3">Top Members</h5>
          <ul class="list-group list-group-flush">
            {% for member in top_members %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ member.full_name|default:member }}</strong><br>
                <small class="text-muted">{{ member.member_id|default:"No ID" }}</small>
              </div>
              <span class="fw-semibold text-success">â‚±{{ member.total_spent|default:0|floatformat:2 }}</span>
            </li>
            {% empty %}
            <li class="list-group-item text-center text-muted">No member purchases yet</li>
            {% endfor %}
          </ul>
        </div>
      </div>
      <div class="col-xl-8">
        <div class="chart-card table-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Recent Transactions</h5>
            <a href="{% url 'transaction_history' %}" class="btn btn-sm btn-outline-secondary rounded-pill">View all</a>
          </div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Transaction #</th>
                  <th>Member</th>
                  <th>Amount</th>
                  <th>Method</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                {% for txn in recent_transactions %}
                <tr>
                  <td class="fw-semibold">{{ txn.transaction_number }}</td>
                  <td>{{ txn.member.full_name|default:"Guest" }}</td>
                  <td class="fw-semibold">â‚±{{ txn.total_amount|floatformat:2 }}</td>
                  <td><span class="badge bg-light text-dark text-uppercase">{{ txn.get_payment_method_display }}</span></td>
                  <td>{{ txn.created_at|date:"M d, Y H:i" }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center text-muted py-4">No transactions yet</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="row g-4">
      <div class="col-xl-6">
        <div class="chart-card table-card">
          <h5 class="mb-3">Top Selling Products</h5>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Sold</th>
                  <th>Revenue</th>
                </tr>
              </thead>
              <tbody>
                {% for product in top_products %}
                <tr>
                  <td>{{ product.product_name }}</td>
                  <td>{{ product.total_sold }}</td>
                  <td>â‚±{{ product.total_revenue|floatformat:2 }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="3" class="text-center text-muted">No sales data yet</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="col-xl-6">
        <div class="chart-card">
          <h5 class="mb-3">Operational Insights</h5>
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span><strong>{{ low_stock_products }}</strong> products are below safety stock.</span>
              <a href="{% url 'inventory_management' %}" class="btn btn-outline-success btn-sm rounded-pill">Review</a>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>Total patronage pool sits at <strong>â‚±{{ total_patronage|floatformat:2 }}</strong>.</span>
              <a href="{% url 'patronage_settings' %}" class="btn btn-outline-success btn-sm rounded-pill">Configure</a>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span><strong>{{ members_with_utang }}</strong> members carry an outstanding balance.</span>
              <a href="{% url 'member_management' %}" class="btn btn-outline-success btn-sm rounded-pill">Notify</a>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span><strong>{{ total_refunds }}</strong> refunds processed totaling <strong>â‚±{{ total_refund_amount|floatformat:2 }}</strong>.</span>
              <a href="{% url 'process_refund' %}" class="btn btn-outline-warning btn-sm rounded-pill">Manage</a>
            </li>
          </ul>
        </div>
      </div>
    </section>
  </main>

  <!-- Balance Refill Modal -->
  <div class="modal fade" id="refillBalanceModal" tabindex="-1" aria-labelledby="refillBalanceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="refillBalanceModalLabel">
            <i class="bi bi-wallet2 me-2"></i>Refill Card Balance
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="refillBalanceForm">
            {% csrf_token %}
            <div class="mb-3">
              <label for="memberSearch" class="form-label">Search Member</label>
              <div class="input-group">
                <input type="text" class="form-control" id="memberSearch" placeholder="Search by RFID, name, or email..." autocomplete="off">
                <button class="btn btn-outline-secondary" type="button" id="searchMemberBtn">
                  <i class="bi bi-search"></i>
                </button>
              </div>
              <div id="memberSearchResults" class="mt-2" style="display: none;">
                <div class="list-group" id="memberResultsList"></div>
              </div>
              <small class="text-muted">Type at least 2 characters to search</small>
            </div>

            <div class="mb-3" id="selectedMemberInfo" style="display: none;">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title mb-2">Selected Member</h6>
                  <p class="mb-1"><strong>Name:</strong> <span id="selectedMemberName">-</span></p>
                  <p class="mb-1"><strong>RFID:</strong> <span id="selectedMemberRfid">-</span></p>
                  <p class="mb-0"><strong>Current Balance:</strong> <span id="selectedMemberBalance" class="text-success fw-bold">â‚±0.00</span></p>
                  <input type="hidden" id="selectedMemberId" value="">
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="refillAmount" class="form-label">Amount to Add</label>
              <div class="input-group">
                <span class="input-group-text">â‚±</span>
                <input type="number" class="form-control" id="refillAmount" placeholder="0.00" step="0.01" min="0.01" required>
              </div>
            </div>

            <div class="mb-3">
              <label for="refillNotes" class="form-label">Notes (Optional)</label>
              <textarea class="form-control" id="refillNotes" rows="2" placeholder="Add any notes about this transaction..."></textarea>
            </div>

            <div id="refillAlert" style="display: none;"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="submitRefillBtn" disabled>
            <i class="bi bi-check-circle me-1"></i>Refill Balance
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Data injected from server as JSON
    let dailySalesLabels, dailySalesTotals, paymentLabels, paymentTotals, categoryLabels, categoryTotals;
    let dailyRefundLabels, dailyRefundAmounts, dailyRefundCounts;

    try {
      dailySalesLabels = {{ daily_sales_labels|default:'[]'|safe }};
      dailySalesTotals = {{ daily_sales_totals|default:'[]'|safe }};
      paymentLabels = {{ payment_labels|default:'[]'|safe }};
      paymentTotals = {{ payment_totals|default:'[]'|safe }};
      categoryLabels = {{ category_labels|default:'[]'|safe }};
      categoryTotals = {{ category_totals|default:'[]'|safe }};
      dailyRefundLabels = {{ daily_refund_labels|default:'[]'|safe }};
      dailyRefundAmounts = {{ daily_refund_amounts|default:'[]'|safe }};
      dailyRefundCounts = {{ daily_refund_counts|default:'[]'|safe }};
    } catch (e) {
      console.error('Error parsing chart data:', e);
      dailySalesLabels = [];
      dailySalesTotals = [];
      paymentLabels = [];
      paymentTotals = [];
      categoryLabels = [];
      categoryTotals = [];
      dailyRefundLabels = [];
      dailyRefundAmounts = [];
      dailyRefundCounts = [];
    }

    // Ensure we have arrays
    const safeDailySalesLabels = Array.isArray(dailySalesLabels) ? dailySalesLabels : [];
    const safeDailySalesTotals = Array.isArray(dailySalesTotals) ? dailySalesTotals : [];
    const safePaymentLabels = Array.isArray(paymentLabels) ? paymentLabels : [];
    const safePaymentTotals = Array.isArray(paymentTotals) ? paymentTotals : [];
    const safeCategoryLabels = Array.isArray(categoryLabels) ? categoryLabels : [];
    const safeCategoryTotals = Array.isArray(categoryTotals) ? categoryTotals : [];
    const safeDailyRefundLabels = Array.isArray(dailyRefundLabels) ? dailyRefundLabels : [];
    const safeDailyRefundAmounts = Array.isArray(dailyRefundAmounts) ? dailyRefundAmounts : [];
    const safeDailyRefundCounts = Array.isArray(dailyRefundCounts) ? dailyRefundCounts : [];

    // Normalize numeric arrays to numbers
    const normNumbers = (arr) => Array.isArray(arr) ? arr.map(v => { const n = Number(v); return isNaN(n) ? 0 : n; }) : [];

    const normDailyTotals = normNumbers(safeDailySalesTotals);
    const normPaymentTotals = normNumbers(safePaymentTotals);
    const normCategoryTotals = normNumbers(safeCategoryTotals);
    const normRefundAmounts = normNumbers(safeDailyRefundAmounts);
    const normRefundCounts = normNumbers(safeDailyRefundCounts);

    // Ensure labels/data length match for sales chart
    if (safeDailySalesLabels.length !== normDailyTotals.length) {
      const len = Math.max(safeDailySalesLabels.length, normDailyTotals.length);
      while (safeDailySalesLabels.length < len) safeDailySalesLabels.push('');
      while (normDailyTotals.length < len) normDailyTotals.push(0);
    }

    // Create gradient function
    const createGradient = (ctx, colorStops, height) => {
      const canvasHeight = height || ctx.canvas.height || 240;
      const gradient = ctx.createLinearGradient(0, 0, 0, canvasHeight);
      for (const stop of colorStops) {
        gradient.addColorStop(stop.position, stop.color);
      }
      return gradient;
    };

    // Store chart instances
    let salesTrendChartInstance = null;

    // Initialize all charts
    function initializeAllCharts() {
      // Check if Chart.js is available
      if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        const chartContainers = ['salesTrendChart', 'paymentMixChart', 'refundTrendChart', 'categoryChart'];
        chartContainers.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            const wrapper = el.closest('.chart-wrapper');
            if (wrapper) {
              wrapper.innerHTML = '<div class="text-center text-muted p-4"><i class="bi bi-exclamation-triangle me-2"></i>Chart library not loaded</div>';
            }
          }
        });
        return;
      }

      const salesCanvas = document.getElementById('salesTrendChart');
      if (salesCanvas) {
        try {
          const salesCtx = salesCanvas.getContext('2d');
          if (!salesCtx) {
            throw new Error('Could not get 2d context');
          }

          // Get the wrapper height for gradient
          const wrapper = salesCanvas.closest('.chart-wrapper');
          const wrapperHeight = wrapper ? wrapper.clientHeight : 240;

          const salesGradient = createGradient(salesCtx, [
            { position: 0, color: 'rgba(31,122,58,0.4)' },
            { position: 0.5, color: 'rgba(31,122,58,0.15)' },
            { position: 1, color: 'rgba(31,122,58,0)' }
          ], wrapperHeight);

          salesTrendChartInstance = new Chart(salesCtx, {
            type: 'line',
            data: {
              labels: safeDailySalesLabels.length > 0 ? safeDailySalesLabels : ['No data'],
              datasets: [{
                label: 'Revenue',
                data: normDailyTotals.length > 0 ? normDailyTotals : [0],
                tension: 0.5,
                borderColor: '#1f7a3a',
                backgroundColor: salesGradient,
                borderWidth: 3,
                fill: true,
                pointRadius: 5,
                pointBackgroundColor: '#ffffff',
                pointBorderColor: '#1f7a3a',
                pointBorderWidth: 3,
                pointHoverRadius: 8,
                pointHoverBackgroundColor: '#1f7a3a',
                pointHoverBorderColor: '#ffffff',
                pointHoverBorderWidth: 3
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                intersect: false,
                mode: 'index'
              },
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: 'rgba(15, 23, 42, 0.95)',
                  padding: 12,
                  titleFont: {
                    size: 14,
                    weight: 'bold'
                  },
                  bodyFont: {
                    size: 13
                  },
                  titleColor: '#ffffff',
                  bodyColor: '#ffffff',
                  borderColor: '#1f7a3a',
                  borderWidth: 2,
                  cornerRadius: 8,
                  displayColors: false,
                  callbacks: {
                    title: function(context) {
                      return context[0].label;
                    },
                    label: function(context) {
                      return 'Revenue: â‚±' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    }
                  }
                }
              },
              scales: {
                x: {
                  grid: {
                    display: false,
                    drawBorder: false
                  },
                  ticks: {
                    font: {
                      size: 11
                    },
                    color: '#64748b',
                    padding: 8
                  }
                },
                y: {
                  beginAtZero: true,
                  ticks: {
                    font: {
                      size: 11
                    },
                    color: '#64748b',
                    padding: 8,
                    callback: function(value) {
                      return 'â‚±' + value.toLocaleString();
                    }
                  },
                  grid: {
                    color: 'rgba(148, 163, 184, 0.1)',
                    drawBorder: false,
                    lineWidth: 1
                  }
                }
              }
            }
          });
          
          // Calculate and display summary statistics
          if (normDailyTotals.length > 0) {
            const totalRevenue = normDailyTotals.reduce((a, b) => a + b, 0);
            const avgDaily = totalRevenue / normDailyTotals.length;
            
            // Find peak day
            let peakIndex = 0;
            let peakValue = normDailyTotals[0];
            normDailyTotals.forEach((val, idx) => {
              if (val > peakValue) {
                peakValue = val;
                peakIndex = idx;
              }
            });
            
            // Calculate week-over-week growth (first 7 days vs last 7 days)
            const firstWeek = normDailyTotals.slice(0, 7).reduce((a, b) => a + b, 0);
            const secondWeek = normDailyTotals.slice(7, 14).reduce((a, b) => a + b, 0);
            let growthPercent = 0;
            if (firstWeek > 0) {
              growthPercent = ((secondWeek - firstWeek) / firstWeek) * 100;
            } else if (secondWeek > 0) {
              growthPercent = 100;
            }
            
            // Update UI elements
            const total14DayEl = document.getElementById('total14DayRevenue');
            const avgDailyEl = document.getElementById('avgDailyRevenue');
            const peakDayAmountEl = document.getElementById('peakDayAmount');
            const peakDayLabelEl = document.getElementById('peakDayLabel');
            const growthPercentEl = document.getElementById('growthPercentage');
            const growthLabelEl = document.getElementById('growthLabel');
            const growthCard = document.getElementById('growthCard');
            
            if (total14DayEl) {
              total14DayEl.textContent = 'â‚±' + totalRevenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }
            if (avgDailyEl) {
              avgDailyEl.textContent = 'â‚±' + avgDaily.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }
            if (peakDayAmountEl && peakDayLabelEl) {
              peakDayAmountEl.textContent = 'â‚±' + peakValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
              peakDayLabelEl.textContent = safeDailySalesLabels[peakIndex] || '-';
            }
            if (growthPercentEl && growthLabelEl && growthCard) {
              const isPositive = growthPercent >= 0;
              const color = isPositive ? '#10b981' : '#ef4444';
              const icon = isPositive ? 'â†‘' : 'â†“';
              growthPercentEl.textContent = (isPositive ? '+' : '') + growthPercent.toFixed(1) + '%';
              growthPercentEl.style.color = color;
              growthCard.style.borderColor = color;
              growthLabelEl.innerHTML = `<i class="bi bi-${isPositive ? 'arrow-up' : 'arrow-down'}" style="font-size: 0.7rem;"></i> Week over week`;
            }
          }
        } catch (err) {
          console.error('Sales Trend chart error', err);
          const wrapper = salesCanvas.closest('.chart-wrapper');
          if (wrapper) {
            wrapper.innerHTML = '<div class="text-center text-muted p-4"><i class="bi bi-exclamation-triangle me-2"></i>Unable to load chart</div>';
          }
        }
      }

      // Initialize Payment Mix Chart
      const paymentEl = document.getElementById('paymentMixChart');
      if (paymentEl) {
        try {
          const paymentCtx = paymentEl.getContext('2d');
          if (!paymentCtx) {
            throw new Error('Could not get 2d context');
          }

          if (Array.isArray(normPaymentTotals) && normPaymentTotals.length > 0 && normPaymentTotals.some(v => v > 0)) {
            const totalAmount = normPaymentTotals.reduce((a, b) => a + b, 0);
            const paymentMixTotal = document.getElementById('paymentMixTotal');
            const paymentMethodBreakdown = document.getElementById('paymentMethodBreakdown');
            
            // Update center total
            if (paymentMixTotal) {
              paymentMixTotal.textContent = 'â‚±' + totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }

            // Payment method icons mapping
            const paymentIcons = {
              'Cash': 'bi-cash-coin',
              'Debit': 'bi-credit-card-2-front',
              'Credit': 'bi-credit-card',
              'Card': 'bi-card-text',
              'Other': 'bi-wallet2'
            };

            // Create breakdown cards
            if (paymentMethodBreakdown) {
              paymentMethodBreakdown.innerHTML = '';
              safePaymentLabels.forEach((label, i) => {
                const value = normPaymentTotals[i];
                const percentage = ((value / totalAmount) * 100).toFixed(1);
                const icon = paymentIcons[label] || paymentIcons['Other'];
                const colors = [
                  { bg: 'rgba(22, 163, 74, 0.1)', border: 'rgba(22, 163, 74, 0.3)', text: '#16a34a' },   // Green for Debit
                  { bg: 'rgba(249, 115, 22, 0.1)', border: 'rgba(249, 115, 22, 0.3)', text: '#f97316' },  // Orange for Credit
                  { bg: 'rgba(14, 165, 233, 0.1)', border: 'rgba(14, 165, 233, 0.3)', text: '#0ea5e9' },  // Blue for Cash
                  { bg: 'rgba(139, 92, 246, 0.1)', border: 'rgba(139, 92, 246, 0.3)', text: '#8b5cf6' },  // Purple
                  { bg: 'rgba(239, 68, 68, 0.1)', border: 'rgba(239, 68, 68, 0.3)', text: '#ef4444' }     // Red
                ];
                const color = colors[i % colors.length];
                
                const card = document.createElement('div');
                card.className = 'col-6';
                card.innerHTML = `
                  <div class="d-flex align-items-center p-2 rounded" style="background: ${color.bg}; border-left: 3px solid ${color.border};">
                    <div class="me-2">
                      <i class="bi ${icon}" style="color: ${color.text}; font-size: 1.2rem;"></i>
                    </div>
                    <div class="flex-grow-1" style="min-width: 0;">
                      <div class="fw-semibold text-truncate" style="font-size: 0.75rem; color: ${color.text};">${label}</div>
                      <div class="fw-bold" style="font-size: 0.85rem; color: #0f172a;">â‚±${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                      <small class="text-muted" style="font-size: 0.7rem;">${percentage}%</small>
                    </div>
                  </div>
                `;
                paymentMethodBreakdown.appendChild(card);
              });
            }

            const paymentChart = new Chart(paymentCtx, {
              type: 'doughnut',
              data: {
                labels: safePaymentLabels,
                datasets: [{
                  data: normPaymentTotals,
                  backgroundColor: [
                    'rgba(22, 163, 74, 0.95)',   // Green for Debit
                    'rgba(249, 115, 22, 0.95)',  // Orange for Credit
                    'rgba(14, 165, 233, 0.95)',  // Blue for Cash
                    'rgba(139, 92, 246, 0.95)',  // Purple
                    'rgba(239, 68, 68, 0.95)'    // Red
                  ],
                  borderColor: '#ffffff',
                  borderWidth: 4,
                  hoverOffset: 15,
                  hoverBorderWidth: 5
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  },
                  tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.98)',
                    padding: 16,
                    titleFont: {
                      size: 15,
                      weight: 'bold'
                    },
                    bodyFont: {
                      size: 14,
                      weight: '500'
                    },
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#ffffff',
                    borderWidth: 2,
                    cornerRadius: 12,
                    displayColors: true,
                    boxPadding: 8,
                    callbacks: {
                      label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((value / total) * 100).toFixed(1);
                        return `${label}: â‚±${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${percentage}%)`;
                      }
                    }
                  }
                },
                cutout: '75%',
                animation: {
                  animateRotate: true,
                  animateScale: true,
                  duration: 1200,
                  easing: 'easeOutQuart'
                }
              }
            });
          } else {
            const wrapper = paymentEl.closest('.chart-wrapper');
            if (wrapper) {
              wrapper.innerHTML = '<div class="text-center text-muted p-4"><i class="bi bi-info-circle me-2"></i>No payment data available</div>';
            }
            const paymentMixTotal = document.getElementById('paymentMixTotal');
            if (paymentMixTotal) {
              paymentMixTotal.textContent = 'â‚±0.00';
            }
            const paymentMethodBreakdown = document.getElementById('paymentMethodBreakdown');
            if (paymentMethodBreakdown) {
              paymentMethodBreakdown.innerHTML = '<div class="col-12 text-center text-muted py-3"><small>No payment data to display</small></div>';
            }
          }
        } catch (err) {
          console.error('Payment Mix chart error', err);
          const wrapper = paymentEl.closest('.chart-wrapper');
          if (wrapper) {
            wrapper.innerHTML = '<div class="text-center text-muted p-4"><i class="bi bi-exclamation-triangle me-2"></i>Unable to load chart</div>';
          }
        }
      }

      // Initialize Refund Trend Chart
      const refundEl = document.getElementById('refundTrendChart');
      if (refundEl) {
        try {
          const refundCtx = refundEl.getContext('2d');
          if (!refundCtx) {
            throw new Error('Could not get 2d context');
          }

          const wrapper = refundEl.closest('.chart-wrapper');
          const wrapperHeight = wrapper ? wrapper.clientHeight : 240;

          const refundGradient = createGradient(refundCtx, [
            { position: 0, color: 'rgba(239, 68, 68, 0.4)' },
            { position: 0.5, color: 'rgba(239, 68, 68, 0.15)' },
            { position: 1, color: 'rgba(239, 68, 68, 0)' }
          ], wrapperHeight);

          new Chart(refundCtx, {
            type: 'line',
            data: {
              labels: safeDailyRefundLabels.length > 0 ? safeDailyRefundLabels : ['No data'],
              datasets: [
                {
                  label: 'Refund Amount',
                  data: normRefundAmounts.length > 0 ? normRefundAmounts : [0],
                  tension: 0.5,
                  borderColor: '#ef4444',
                  backgroundColor: refundGradient,
                  borderWidth: 3,
                  fill: true,
                  pointRadius: 5,
                  pointBackgroundColor: '#ffffff',
                  pointBorderColor: '#ef4444',
                  pointBorderWidth: 3,
                  pointHoverRadius: 8,
                  pointHoverBackgroundColor: '#ef4444',
                  pointHoverBorderColor: '#ffffff',
                  pointHoverBorderWidth: 3,
                  yAxisID: 'y'
                },
                {
                  label: 'Refund Count',
                  data: normRefundCounts.length > 0 ? normRefundCounts : [0],
                  tension: 0.5,
                  borderColor: '#f59e0b',
                  backgroundColor: 'rgba(245, 158, 11, 0.1)',
                  borderWidth: 2,
                  fill: false,
                  pointRadius: 4,
                  pointBackgroundColor: '#ffffff',
                  pointBorderColor: '#f59e0b',
                  pointBorderWidth: 2,
                  pointHoverRadius: 7,
                  pointHoverBackgroundColor: '#f59e0b',
                  pointHoverBorderColor: '#ffffff',
                  pointHoverBorderWidth: 2,
                  yAxisID: 'y1'
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                intersect: false,
                mode: 'index'
              },
              plugins: {
                legend: {
                  display: true,
                  position: 'top',
                  labels: {
                    usePointStyle: true,
                    padding: 12,
                    font: {
                      size: 12,
                      weight: '500'
                    }
                  }
                },
                tooltip: {
                  backgroundColor: 'rgba(15, 23, 42, 0.95)',
                  padding: 12,
                  titleFont: {
                    size: 14,
                    weight: 'bold'
                  },
                  bodyFont: {
                    size: 13
                  },
                  titleColor: '#ffffff',
                  bodyColor: '#ffffff',
                  borderColor: '#ef4444',
                  borderWidth: 2,
                  cornerRadius: 8,
                  displayColors: true,
                  callbacks: {
                    title: function(context) {
                      return context[0].label;
                    },
                    label: function(context) {
                      if (context.datasetIndex === 0) {
                        return 'Amount: â‚±' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                      } else {
                        return 'Count: ' + context.parsed.y + ' refund(s)';
                      }
                    }
                  }
                }
              },
              scales: {
                x: {
                  grid: {
                    display: false,
                    drawBorder: false
                  },
                  ticks: {
                    font: {
                      size: 11
                    },
                    color: '#64748b',
                    padding: 8
                  }
                },
                y: {
                  type: 'linear',
                  display: true,
                  position: 'left',
                  beginAtZero: true,
                  ticks: {
                    font: {
                      size: 11
                    },
                    color: '#ef4444',
                    padding: 8,
                    callback: function(value) {
                      return 'â‚±' + value.toLocaleString();
                    }
                  },
                  grid: {
                    color: 'rgba(239, 68, 68, 0.1)',
                    drawBorder: false,
                    lineWidth: 1
                  },
                  title: {
                    display: true,
                    text: 'Amount (â‚±)',
                    color: '#ef4444',
                    font: {
                      size: 11,
                      weight: '600'
                    }
                  }
                },
                y1: {
                  type: 'linear',
                  display: true,
                  position: 'right',
                  beginAtZero: true,
                  ticks: {
                    font: {
                      size: 11
                    },
                    color: '#f59e0b',
                    padding: 8,
                    callback: function(value) {
                      return value + ' refunds';
                    }
                  },
                  grid: {
                    drawOnChartArea: false,
                    drawBorder: false
                  },
                  title: {
                    display: true,
                    text: 'Count',
                    color: '#f59e0b',
                    font: {
                      size: 11,
                      weight: '600'
                    }
                  }
                }
              }
            }
          });
        } catch (err) {
          console.error('Refund Trend chart error', err);
          const wrapper = refundEl.closest('.chart-wrapper');
          if (wrapper) {
            wrapper.innerHTML = '<div class="text-center text-muted p-4"><i class="bi bi-exclamation-triangle me-2"></i>Unable to load chart</div>';
          }
        }
      }

      // Initialize Category Chart
      const categoryEl = document.getElementById('categoryChart');
      if (categoryEl) {
        try {
          const categoryCtx = categoryEl.getContext('2d');
          if (!categoryCtx) {
            throw new Error('Could not get 2d context');
          }

          if (Array.isArray(normCategoryTotals) && normCategoryTotals.length > 0 && normCategoryTotals.some(v => v > 0)) {
            new Chart(categoryCtx, {
              type: 'bar',
              data: {
                labels: safeCategoryLabels,
                datasets: [{
                  label: 'Revenue',
                  data: normCategoryTotals,
                  backgroundColor: 'rgba(14, 165, 233, 0.8)',
                  borderColor: 'rgba(14, 165, 233, 1)',
                  borderWidth: 2,
                  borderRadius: 6,
                  barThickness: 24,
                  maxBarThickness: 30
                }]
              },
              options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        return `â‚±${context.parsed.x.toLocaleString()}`;
                      }
                    }
                  }
                },
                scales: {
                  x: {
                    beginAtZero: true,
                    ticks: {
                      font: { size: 11 },
                      color: '#64748b',
                      padding: 8,
                      callback: function(value) {
                        return 'â‚±' + value.toLocaleString();
                      }
                    },
                    grid: {
                      color: 'rgba(148, 163, 184, 0.1)',
                      drawBorder: false,
                      lineWidth: 1
                    }
                  },
                  y: {
                    grid: {
                      display: false,
                      drawBorder: false
                    },
                    ticks: {
                      font: { size: 11 },
                      color: '#64748b',
                      padding: 8
                    }
                  }
                }
              }
            });
          } else {
            const wrapper = categoryEl.closest('.chart-wrapper');
            if (wrapper) {
              wrapper.innerHTML = '<div class="text-center text-muted p-4"><i class="bi bi-info-circle me-2"></i>No category data available</div>';
            }
          }
        } catch (err) {
          console.error('Category chart error', err);
          const wrapper = categoryEl.closest('.chart-wrapper');
          if (wrapper) {
            wrapper.innerHTML = '<div class="text-center text-muted p-4"><i class="bi bi-exclamation-triangle me-2"></i>Unable to load chart</div>';
          }
        }
      }
    }

    // Initialize charts when DOM and Chart.js are ready
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof Chart !== 'undefined') {
        initializeAllCharts();
      } else {
        // Wait for Chart.js to load
        let attempts = 0;
        const checkChart = setInterval(() => {
          attempts++;
          if (typeof Chart !== 'undefined') {
            clearInterval(checkChart);
            initializeAllCharts();
          } else if (attempts > 50) {
            clearInterval(checkChart);
            console.error('Chart.js failed to load');
            initializeAllCharts(); // Will show error messages
          }
        }, 100);
      }

      // Sales Trend Chart Expand/Collapse Functionality
      const salesTrendCard = document.getElementById('salesTrendCard');
      const expandSalesChartBtn = document.getElementById('expandSalesChartBtn');
      const expandSalesChartIcon = document.getElementById('expandSalesChartIcon');
      const salesTrendWrapper = document.getElementById('salesTrendWrapper');
      let isSalesChartExpanded = false;

      if (expandSalesChartBtn && salesTrendCard) {
        expandSalesChartBtn.addEventListener('click', () => {
          isSalesChartExpanded = !isSalesChartExpanded;
          
          if (isSalesChartExpanded) {
            // Expand
            salesTrendCard.classList.add('expanded');
            expandSalesChartIcon.className = 'bi bi-fullscreen-exit';
            expandSalesChartBtn.title = 'Collapse chart';
            
            // Update gradient for expanded view
            if (salesTrendChartInstance) {
              const wrapper = salesTrendChartInstance.canvas.closest('.chart-wrapper');
              const wrapperHeight = wrapper ? wrapper.clientHeight : window.innerHeight - 150;
              const salesCtx = salesTrendChartInstance.canvas.getContext('2d');
              const salesGradient = createGradient(salesCtx, [
                { position: 0, color: 'rgba(31,122,58,0.4)' },
                { position: 0.5, color: 'rgba(31,122,58,0.15)' },
                { position: 1, color: 'rgba(31,122,58,0)' }
              ], wrapperHeight);
              
              // Update the dataset background color
              salesTrendChartInstance.data.datasets[0].backgroundColor = salesGradient;
              salesTrendChartInstance.update('none');
            }
            
            // Resize chart after a short delay to ensure container is resized
            setTimeout(() => {
              if (salesTrendChartInstance) {
                salesTrendChartInstance.resize();
              }
            }, 100);
          } else {
            // Collapse
            salesTrendCard.classList.remove('expanded');
            expandSalesChartIcon.className = 'bi bi-arrows-fullscreen';
            expandSalesChartBtn.title = 'Expand chart';
            
            // Update gradient for collapsed view
            if (salesTrendChartInstance) {
              const wrapper = salesTrendChartInstance.canvas.closest('.chart-wrapper');
              const wrapperHeight = 280;
              const salesCtx = salesTrendChartInstance.canvas.getContext('2d');
              const salesGradient = createGradient(salesCtx, [
                { position: 0, color: 'rgba(31,122,58,0.4)' },
                { position: 0.5, color: 'rgba(31,122,58,0.15)' },
                { position: 1, color: 'rgba(31,122,58,0)' }
              ], wrapperHeight);
              
              // Update the dataset background color
              salesTrendChartInstance.data.datasets[0].backgroundColor = salesGradient;
              salesTrendChartInstance.update('none');
            }
            
            // Resize chart after a short delay
            setTimeout(() => {
              if (salesTrendChartInstance) {
                salesTrendChartInstance.resize();
              }
            }, 100);
          }
        });

        // Close expanded chart on Escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && isSalesChartExpanded) {
            expandSalesChartBtn.click();
          }
        });

        // Handle window resize for expanded chart
        window.addEventListener('resize', () => {
          if (isSalesChartExpanded && salesTrendChartInstance) {
            setTimeout(() => {
              salesTrendChartInstance.resize();
            }, 100);
          }
        });
      }
    });

    // Balance Refill Functionality
    (function() {
      function getCsrfToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (token) return token;
        // Fallback: try to get from cookie
        const name = 'csrftoken';
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          const [key, value] = cookie.trim().split('=');
          if (key === name) return value;
        }
        return '';
      }
      
      const csrftoken = getCsrfToken();
      
      let searchTimeout = null;
      let selectedMember = null;

      const memberSearchInput = document.getElementById('memberSearch');
      const searchMemberBtn = document.getElementById('searchMemberBtn');
      const memberSearchResults = document.getElementById('memberSearchResults');
      const memberResultsList = document.getElementById('memberResultsList');
      const selectedMemberInfo = document.getElementById('selectedMemberInfo');
      const selectedMemberName = document.getElementById('selectedMemberName');
      const selectedMemberRfid = document.getElementById('selectedMemberRfid');
      const selectedMemberBalance = document.getElementById('selectedMemberBalance');
      const selectedMemberId = document.getElementById('selectedMemberId');
      const refillAmount = document.getElementById('refillAmount');
      const submitRefillBtn = document.getElementById('submitRefillBtn');
      const refillAlert = document.getElementById('refillAlert');
      const refillBalanceModal = document.getElementById('refillBalanceModal');

      function showAlert(message, type = 'success') {
        refillAlert.className = `alert alert-${type} alert-dismissible fade show`;
        refillAlert.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        refillAlert.style.display = 'block';
        setTimeout(() => {
          refillAlert.style.display = 'none';
        }, 5000);
      }

      function searchMembers(query) {
        if (!query || query.length < 2) {
          memberSearchResults.style.display = 'none';
          return;
        }

        fetch(`/api/search-members/?q=${encodeURIComponent(query)}`, {
          method: 'GET',
          headers: {
            'X-CSRFToken': csrftoken
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success && data.members && data.members.length > 0) {
            memberResultsList.innerHTML = '';
            data.members.forEach(member => {
              const item = document.createElement('a');
              item.href = '#';
              item.className = 'list-group-item list-group-item-action';
              item.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                  <div>
                    <h6 class="mb-1">${member.name}</h6>
                    <small class="text-muted">RFID: ${member.rfid} | Email: ${member.email || 'N/A'}</small>
                  </div>
                  <div class="text-end">
                    <small class="text-success fw-bold">â‚±${parseFloat(member.current_balance).toFixed(2)}</small>
                  </div>
                </div>
              `;
              item.addEventListener('click', (e) => {
                e.preventDefault();
                selectMember(member);
              });
              memberResultsList.appendChild(item);
            });
            memberSearchResults.style.display = 'block';
          } else {
            memberResultsList.innerHTML = '<div class="list-group-item text-muted text-center">No members found</div>';
            memberSearchResults.style.display = 'block';
          }
        })
        .catch(err => {
          console.error('Search error:', err);
          showAlert('Error searching members', 'danger');
        });
      }

      function selectMember(member) {
        selectedMember = member;
        selectedMemberName.textContent = member.name;
        selectedMemberRfid.textContent = member.rfid;
        selectedMemberBalance.textContent = `â‚±${parseFloat(member.current_balance).toFixed(2)}`;
        selectedMemberId.value = member.id;
        selectedMemberInfo.style.display = 'block';
        memberSearchResults.style.display = 'none';
        memberSearchInput.value = member.name;
        updateSubmitButton();
      }

      function updateSubmitButton() {
        const hasMember = selectedMember !== null;
        const hasAmount = refillAmount.value && parseFloat(refillAmount.value) > 0;
        submitRefillBtn.disabled = !(hasMember && hasAmount);
      }

      // Search on input with debounce
      memberSearchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        if (query.length >= 2) {
          searchTimeout = setTimeout(() => searchMembers(query), 300);
        } else {
          memberSearchResults.style.display = 'none';
          selectedMember = null;
          selectedMemberInfo.style.display = 'none';
          updateSubmitButton();
        }
      });

      searchMemberBtn.addEventListener('click', () => {
        const query = memberSearchInput.value.trim();
        if (query.length >= 2) {
          searchMembers(query);
        }
      });

      refillAmount.addEventListener('input', updateSubmitButton);

      // Handle form submission
      submitRefillBtn.addEventListener('click', () => {
        if (!selectedMember || !refillAmount.value) {
          showAlert('Please select a member and enter an amount', 'warning');
          return;
        }

        const amount = parseFloat(refillAmount.value);
        if (isNaN(amount) || amount <= 0) {
          showAlert('Please enter a valid amount greater than zero', 'warning');
          return;
        }

        submitRefillBtn.disabled = true;
        submitRefillBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Processing...';

        const payload = {
          member_id: selectedMember.id,
          amount: amount,
          notes: document.getElementById('refillNotes').value.trim()
        };

        fetch('/api/refill-balance/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showAlert(data.message, 'success');
            // Reset form
            memberSearchInput.value = '';
            refillAmount.value = '';
            document.getElementById('refillNotes').value = '';
            selectedMember = null;
            selectedMemberInfo.style.display = 'none';
            memberSearchResults.style.display = 'none';
            
            // Reload page after 1.5 seconds to refresh dashboard data
            setTimeout(() => {
              window.location.reload();
            }, 1500);
          } else {
            showAlert(data.error || 'Failed to refill balance', 'danger');
            submitRefillBtn.disabled = false;
            submitRefillBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Refill Balance';
          }
        })
        .catch(err => {
          console.error('Refill error:', err);
          showAlert('Error processing balance refill', 'danger');
          submitRefillBtn.disabled = false;
          submitRefillBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Refill Balance';
        });
      });

      // Reset form when modal is closed
      refillBalanceModal.addEventListener('hidden.bs.modal', () => {
        memberSearchInput.value = '';
        refillAmount.value = '';
        document.getElementById('refillNotes').value = '';
        selectedMember = null;
        selectedMemberInfo.style.display = 'none';
        memberSearchResults.style.display = 'none';
        refillAlert.style.display = 'none';
        submitRefillBtn.disabled = true;
        submitRefillBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Refill Balance';
      });
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
