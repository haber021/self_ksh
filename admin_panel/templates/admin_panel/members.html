<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Member Management | Cooperative Store</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --dark: #0f172a;
      --brand: #1f7a3a;
      --accent: #0b5f3a;
      --muted: #94a3b8;
      --panel: #ffffff;
      --gradient: linear-gradient(135deg, #1f7a3a 0%, #0b5f3a 40%, #0d9488 100%);
    }

    body {
      background: #f1f5f9;
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', sans-serif;
    }

    .super-nav {
      background: var(--dark);
      color: #fff;
      box-shadow: 0 10px 30px rgba(15,23,42,0.4);
    }

    .nav-pill {
      border-radius: 999px;
      padding: 8px 18px;
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
    }

    .nav-pill.active, .nav-pill:hover {
      background: rgba(255,255,255,0.15);
      color: #fff;
    }

    .hero-card {
      background: var(--gradient);
      color: #fff;
      border-radius: 24px;
      padding: 32px;
      box-shadow: 0 25px 55px rgba(15,23,42,0.35);
    }

    .stat-card {
      border: none;
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 18px 36px rgba(15,23,42,0.08);
      background: var(--panel);
      height: 100%;
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      color: #fff;
    }

    .stat-title {
      color: var(--muted);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .table-card {
      border-radius: 20px;
      padding: 20px;
      background: var(--panel);
      box-shadow: 0 15px 30px rgba(15,23,42,0.07);
    }

    .table-card table {
      font-size: 0.9rem;
    }

    .table-card thead {
      color: var(--muted);
      text-transform: uppercase;
      font-size: 0.75rem;
    }

    .badge-role {
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.75rem;
    }

    .role-admin {
      background: #fef3c7;
      color: #92400e;
    }

    .role-cashier {
      background: #dbeafe;
      color: #1e40af;
    }

    .role-member {
      background: #d1fae5;
      color: #065f46;
    }

    .balance-positive {
      color: #059669;
      font-weight: 600;
    }

    .balance-negative {
      color: #dc2626;
      font-weight: 600;
    }

    .utang-badge {
      background: #fee2e2;
      color: #991b1b;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <nav class="navbar super-nav navbar-expand-lg py-3">
    <div class="container-fluid px-4">
      <a class="navbar-brand fw-bold text-white" href="{% url 'dashboard' %}">
        <i class="bi bi-shield-lock-fill me-2"></i>Super Admin
      </a>
      <form method="post" action="{% url 'admin_logout' %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger rounded-pill px-4">
          <i class="bi bi-box-arrow-right me-1"></i>Logout
        </button>
      </form>
    </div>
  </nav>

  <main class="container-fluid px-4 py-5">
    <section class="hero-card mb-4">
      <div class="row align-items-center">
        <div class="col-lg-8">
          <p class="mb-2 text-uppercase fw-semibold" style="letter-spacing:0.2em;">Member Management</p>
          <h1 class="fw-bold mb-2">Cooperative Members</h1>
          <p class="mb-0 lead text-white-50">
            Manage member accounts, balances, credit standing, and member types from this centralized console.
          </p>
        </div>
        <div class="col-lg-4 text-end">
          <a href="{% url 'dashboard' %}" class="btn btn-light rounded-pill px-4">
            <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
          </a>
        </div>
      </div>
    </section>

    <div class="d-flex gap-2 flex-wrap mb-4">
      <a href="{% url 'dashboard' %}" class="btn btn-outline-success rounded-pill px-4"><i class="bi bi-speedometer2 me-1"></i> Dashboard</a>
      <a href="{% url 'inventory_management' %}" class="btn btn-outline-success rounded-pill px-4"><i class="bi bi-box-seam me-1"></i> Inventory</a>
      <a href="{% url 'member_management' %}" class="btn btn-success rounded-pill px-4 active"><i class="bi bi-people-fill me-1"></i> Members</a>
      <a href="{% url 'transaction_history' %}" class="btn btn-outline-success rounded-pill px-4"><i class="bi bi-receipt me-1"></i> Transactions</a>
      <a href="{% url 'patronage_settings' %}" class="btn btn-outline-success rounded-pill px-4"><i class="bi bi-percent me-1"></i> Patronage</a>
      <button type="button" class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#refillBalanceModal">
        <i class="bi bi-wallet2 me-1"></i> Refill Card Balance
      </button>
    </div>

    <section class="row g-4 mb-4">
      <div class="col-md-3">
        <div class="stat-card">
          <div class="d-flex align-items-center gap-3">
            <div class="stat-icon" style="background:#1f7a3a;">
              <i class="bi bi-people"></i>
            </div>
            <div>
              <div class="stat-title">Total Members</div>
              <h3 class="mb-0">{{ total_members }}</h3>
              <small class="text-muted">All members</small>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="d-flex align-items-center gap-3">
            <div class="stat-icon" style="background:#059669;">
              <i class="bi bi-check-circle"></i>
            </div>
            <div>
              <div class="stat-title">Active Members</div>
              <h3 class="mb-0">{{ active_members }}</h3>
              <small class="text-muted">Currently active</small>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="d-flex align-items-center gap-3">
            <div class="stat-icon" style="background:#f97316;">
              <i class="bi bi-credit-card-2-front"></i>
            </div>
            <div>
              <div class="stat-title">With Utang</div>
              <h3 class="mb-0">{{ members_with_utang }}</h3>
              <small class="text-muted">Outstanding credit</small>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="d-flex align-items-center gap-3">
            <div class="stat-icon" style="background:#6366f1;">
              <i class="bi bi-wallet2"></i>
            </div>
            <div>
              <div class="stat-title">Total Balances</div>
              <h3 class="mb-0">₱{{ total_balances|floatformat:2 }}</h3>
              <small class="text-muted">Combined balances</small>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="row g-4">
      <div class="col-12">
        <div class="table-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">All Members</h5>
            <div class="d-flex gap-2">
              <button type="button" id="addMemberBtn" class="btn btn-success btn-sm rounded-pill">
                <i class="bi bi-plus-circle me-1"></i>Add Member
              </button>
              <button type="button" id="manageMemberTypesBtn" class="btn btn-outline-secondary btn-sm rounded-pill">
                <i class="bi bi-tags me-1"></i>Manage Member Types
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Member</th>
                  <th>RFID Card</th>
                  <th>Member Type</th>
                  <th>Role</th>
                  <th>Balance</th>
                  <th>Utang</th>
                  <th>Patronage</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for member in members %}
                <tr>
                  <td>
                    <div class="fw-semibold">{{ member.full_name }}</div>
                    {% if member.email %}
                    <small class="text-muted">{{ member.email }}</small>
                    {% endif %}
                    {% if member.phone %}
                    <small class="text-muted d-block">{{ member.phone }}</small>
                    {% endif %}
                  </td>
                  <td><code>{{ member.rfid_card_number }}</code></td>
                  <td>
                    {% if member.member_type %}
                    <span class="badge bg-light text-dark">{{ member.member_type.name }}</span>
                    {% else %}
                    <span class="text-muted">No type</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge-role role-{{ member.role }}">
                      {{ member.get_role_display }}
                    </span>
                  </td>
                  <td>
                    <span class="balance-positive">₱{{ member.balance|floatformat:2 }}</span>
                  </td>
                  <td>
                    {% if member.utang_balance > 0 %}
                    <span class="utang-badge">
                      <i class="bi bi-exclamation-triangle me-1"></i>₱{{ member.utang_balance|floatformat:2 }}
                    </span>
                    {% else %}
                    <span class="text-muted">₱0.00</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="text-muted">₱{{ member.total_patronage|floatformat:2 }}</span>
                  </td>
                  <td>
                    {% if member.is_active %}
                    <span class="badge bg-success">Active</span>
                    {% else %}
                    <span class="badge bg-secondary">Inactive</span>
                    {% endif %}
                    {% if member.user %}
                    <span class="badge bg-info ms-1">Has Account</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="d-flex gap-1">
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-primary rounded-pill edit-member-btn"
                        title="Edit Member"
                        data-id="{{ member.id }}"
                        data-first-name="{{ member.first_name|escapejs }}"
                        data-last-name="{{ member.last_name|escapejs }}"
                        data-email="{{ member.email|default_if_none:''|escapejs }}"
                        data-phone="{{ member.phone|escapejs }}"
                        data-rfid="{{ member.rfid_card_number|escapejs }}"
                        data-member-type="{% if member.member_type %}{{ member.member_type.id }}{% endif %}"
                        data-role="{{ member.role }}"
                        data-active="{{ member.is_active }}"
                      >
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-success rounded-pill" onclick="quickRefill({{ member.id }}, '{{ member.full_name }}', '{{ member.rfid_card_number }}', {{ member.balance }})" title="Quick Refill">
                        <i class="bi bi-wallet2"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="9" class="text-center text-muted py-4">
                    <i class="bi bi-inbox me-2"></i>No members found. 
                    <a href="/admin/members/member/add/">Add your first member</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Member Form Modal -->
  <div class="modal fade" id="memberFormModal" tabindex="-1" aria-labelledby="memberFormModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="memberFormModalLabel">Add Member</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="memberFormAlert" style="display:none;"></div>
          <form id="memberForm">
            {% csrf_token %}
            <input type="hidden" id="memberIdInput" />
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">First Name</label>
                <input type="text" class="form-control" id="memberFirstName" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Last Name</label>
                <input type="text" class="form-control" id="memberLastName" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" id="memberEmail" placeholder="optional">
              </div>
              <div class="col-md-6">
                <label class="form-label">Phone</label>
                <input type="text" class="form-control" id="memberPhone" placeholder="optional">
              </div>
              <div class="col-md-6">
                <label class="form-label">RFID Card Number</label>
                <input type="text" class="form-control" id="memberRfid" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Member Type</label>
                <select class="form-select" id="memberTypeSelect">
                  <option value="">No type</option>
                  {% for mt in member_types %}
                  <option value="{{ mt.id }}">{{ mt.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Role</label>
                <select class="form-select" id="memberRole">
                  <option value="member">Member</option>
                  <option value="cashier">Cashier</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
              <div class="col-md-6 d-flex align-items-center">
                <div class="form-check mt-4">
                  <input class="form-check-input" type="checkbox" id="memberIsActive" checked>
                  <label class="form-check-label" for="memberIsActive">
                    Active
                  </label>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveMemberBtn">
            <i class="bi bi-check-circle me-1"></i>Save Member
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Member Type Modal -->
  <div class="modal fade" id="memberTypeModal" tabindex="-1" aria-labelledby="memberTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-secondary text-white">
          <h5 class="modal-title" id="memberTypeModalLabel">Add Member Type</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="memberTypeAlert" style="display:none;"></div>
          <form id="memberTypeForm">
            {% csrf_token %}
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Name</label>
                <input type="text" class="form-control" id="memberTypeName" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Patronage Rate (0 - 1)</label>
                <input type="number" step="0.0001" min="0" max="1" class="form-control" id="memberTypePatronage" value="0.05" required>
              </div>
              <div class="col-12">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="memberTypeDescription" rows="2" placeholder="optional"></textarea>
              </div>
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="memberTypeIsActive" checked>
                  <label class="form-check-label" for="memberTypeIsActive">
                    Active
                  </label>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveMemberTypeBtn">
            <i class="bi bi-plus-circle me-1"></i>Add Type
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Balance Refill Modal -->
  <div class="modal fade" id="refillBalanceModal" tabindex="-1" aria-labelledby="refillBalanceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="refillBalanceModalLabel">
            <i class="bi bi-wallet2 me-2"></i>Refill Card Balance
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="refillBalanceForm">
            {% csrf_token %}
            <div class="mb-3">
              <label for="memberSearch" class="form-label">Search Member</label>
              <div class="input-group">
                <input type="text" class="form-control" id="memberSearch" placeholder="Search by RFID, name, or email..." autocomplete="off">
                <button class="btn btn-outline-secondary" type="button" id="searchMemberBtn">
                  <i class="bi bi-search"></i>
                </button>
              </div>
              <div id="memberSearchResults" class="mt-2" style="display: none;">
                <div class="list-group" id="memberResultsList"></div>
              </div>
              <small class="text-muted">Type at least 2 characters to search</small>
            </div>

            <div class="mb-3" id="selectedMemberInfo" style="display: none;">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title mb-2">Selected Member</h6>
                  <p class="mb-1"><strong>Name:</strong> <span id="selectedMemberName">-</span></p>
                  <p class="mb-1"><strong>RFID:</strong> <span id="selectedMemberRfid">-</span></p>
                  <p class="mb-0"><strong>Current Balance:</strong> <span id="selectedMemberBalance" class="text-success fw-bold">₱0.00</span></p>
                  <input type="hidden" id="selectedMemberId" value="">
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="refillAmount" class="form-label">Amount to Add</label>
              <div class="input-group">
                <span class="input-group-text">₱</span>
                <input type="number" class="form-control" id="refillAmount" placeholder="0.00" step="0.01" min="0.01" required>
              </div>
            </div>

            <div class="mb-3">
              <label for="refillNotes" class="form-label">Notes (Optional)</label>
              <textarea class="form-control" id="refillNotes" rows="2" placeholder="Add any notes about this transaction..."></textarea>
            </div>

            <div id="refillAlert" style="display: none;"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="submitRefillBtn" disabled>
            <i class="bi bi-check-circle me-1"></i>Refill Balance
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Balance Refill Functionality
    (function() {
      function getCsrfToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (token) return token;
        const name = 'csrftoken';
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          const [key, value] = cookie.trim().split('=');
          if (key === name) return value;
        }
        return '';
      }
      
      const csrftoken = getCsrfToken();
      
      let searchTimeout = null;
      let selectedMember = null;

      const memberSearchInput = document.getElementById('memberSearch');
      const searchMemberBtn = document.getElementById('searchMemberBtn');
      const memberSearchResults = document.getElementById('memberSearchResults');
      const memberResultsList = document.getElementById('memberResultsList');
      const selectedMemberInfo = document.getElementById('selectedMemberInfo');
      const selectedMemberName = document.getElementById('selectedMemberName');
      const selectedMemberRfid = document.getElementById('selectedMemberRfid');
      const selectedMemberBalance = document.getElementById('selectedMemberBalance');
      const selectedMemberId = document.getElementById('selectedMemberId');
      const refillAmount = document.getElementById('refillAmount');
      const submitRefillBtn = document.getElementById('submitRefillBtn');
      const refillAlert = document.getElementById('refillAlert');
      const refillBalanceModal = document.getElementById('refillBalanceModal');
      const memberFormModal = document.getElementById('memberFormModal');
      const memberForm = document.getElementById('memberForm');
      const saveMemberBtn = document.getElementById('saveMemberBtn');
      const memberFormAlert = document.getElementById('memberFormAlert');
      const memberModalTitle = document.getElementById('memberFormModalLabel');
      const memberIdInput = document.getElementById('memberIdInput');
      const memberFirstName = document.getElementById('memberFirstName');
      const memberLastName = document.getElementById('memberLastName');
      const memberEmail = document.getElementById('memberEmail');
      const memberPhone = document.getElementById('memberPhone');
      const memberRfid = document.getElementById('memberRfid');
      const memberTypeSelect = document.getElementById('memberTypeSelect');
      const memberRole = document.getElementById('memberRole');
      const memberIsActive = document.getElementById('memberIsActive');
      const addMemberBtn = document.getElementById('addMemberBtn');
      const manageMemberTypesBtn = document.getElementById('manageMemberTypesBtn');
      const memberTypeModal = document.getElementById('memberTypeModal');
      const memberTypeForm = document.getElementById('memberTypeForm');
      const saveMemberTypeBtn = document.getElementById('saveMemberTypeBtn');
      const memberTypeAlert = document.getElementById('memberTypeAlert');
      const memberTypeName = document.getElementById('memberTypeName');
      const memberTypeDescription = document.getElementById('memberTypeDescription');
      const memberTypePatronage = document.getElementById('memberTypePatronage');
      const memberTypeIsActive = document.getElementById('memberTypeIsActive');

      function showAlert(message, type = 'success') {
        refillAlert.className = `alert alert-${type} alert-dismissible fade show`;
        refillAlert.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        refillAlert.style.display = 'block';
        setTimeout(() => {
          refillAlert.style.display = 'none';
        }, 5000);
      }

      function showInlineAlert(target, message, type = 'success') {
        if (!target) return;
        target.className = `alert alert-${type} alert-dismissible fade show`;
        target.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        target.style.display = 'block';
        setTimeout(() => {
          target.style.display = 'none';
        }, 5000);
      }

      function openMemberModal(mode = 'add', data = {}) {
        memberForm.reset();
        memberFormAlert.style.display = 'none';
        memberIdInput.value = mode === 'edit' ? data.id || '' : '';
        memberModalTitle.textContent = mode === 'edit' ? 'Edit Member' : 'Add Member';

        memberFirstName.value = data.first_name || '';
        memberLastName.value = data.last_name || '';
        memberEmail.value = data.email || '';
        memberPhone.value = data.phone || '';
        memberRfid.value = data.rfid || '';
        memberRole.value = data.role || 'member';
        memberIsActive.checked = data.is_active !== undefined ? data.is_active === true || data.is_active === 'True' || data.is_active === 'true' || data.is_active === '1' : true;
        if (memberTypeSelect) {
          memberTypeSelect.value = data.member_type_id || '';
        }

        const modal = new bootstrap.Modal(memberFormModal);
        modal.show();
      }

      function submitMemberForm() {
        const payload = {
          first_name: memberFirstName.value.trim(),
          last_name: memberLastName.value.trim(),
          email: memberEmail.value.trim(),
          phone: memberPhone.value.trim(),
          rfid: memberRfid.value.trim(),
          member_type_id: memberTypeSelect.value || null,
          role: memberRole.value,
          is_active: memberIsActive.checked,
        };

        if (!payload.first_name || !payload.last_name) {
          showInlineAlert(memberFormAlert, 'First and last name are required', 'warning');
          return;
        }
        if (!payload.rfid) {
          showInlineAlert(memberFormAlert, 'RFID card number is required', 'warning');
          return;
        }

        const memberId = memberIdInput.value;
        const url = memberId ? '/api/members/update/' : '/api/members/create/';
        if (memberId) {
          payload.member_id = memberId;
        }

        saveMemberBtn.disabled = true;
        saveMemberBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

        fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showInlineAlert(memberFormAlert, data.message || 'Saved successfully', 'success');
            setTimeout(() => window.location.reload(), 800);
          } else {
            showInlineAlert(memberFormAlert, data.error || 'Unable to save member', 'danger');
            saveMemberBtn.disabled = false;
            saveMemberBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Save Member';
          }
        })
        .catch(() => {
          showInlineAlert(memberFormAlert, 'Server error while saving member', 'danger');
          saveMemberBtn.disabled = false;
          saveMemberBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Save Member';
        });
      }

      function submitMemberTypeForm() {
        const payload = {
          name: memberTypeName.value.trim(),
          description: memberTypeDescription.value.trim(),
          patronage_rate: memberTypePatronage.value,
          is_active: memberTypeIsActive.checked,
        };

        if (!payload.name) {
          showInlineAlert(memberTypeAlert, 'Name is required', 'warning');
          return;
        }

        saveMemberTypeBtn.disabled = true;
        saveMemberTypeBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

        fetch('/api/member-types/create/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showInlineAlert(memberTypeAlert, data.message || 'Member type saved', 'success');
            setTimeout(() => window.location.reload(), 800);
          } else {
            showInlineAlert(memberTypeAlert, data.error || 'Unable to save member type', 'danger');
            saveMemberTypeBtn.disabled = false;
            saveMemberTypeBtn.innerHTML = '<i class="bi bi-plus-circle me-1"></i>Add Type';
          }
        })
        .catch(() => {
          showInlineAlert(memberTypeAlert, 'Server error while saving member type', 'danger');
          saveMemberTypeBtn.disabled = false;
          saveMemberTypeBtn.innerHTML = '<i class="bi bi-plus-circle me-1"></i>Add Type';
        });
      }

      if (addMemberBtn) {
        addMemberBtn.addEventListener('click', () => openMemberModal('add'));
      }

      if (manageMemberTypesBtn) {
        manageMemberTypesBtn.addEventListener('click', () => {
          memberTypeForm.reset();
          memberTypeAlert.style.display = 'none';
          const modal = new bootstrap.Modal(memberTypeModal);
          modal.show();
        });
      }

      document.querySelectorAll('.edit-member-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          openMemberModal('edit', {
            id: btn.dataset.id,
            first_name: btn.dataset.firstName,
            last_name: btn.dataset.lastName,
            email: btn.dataset.email,
            phone: btn.dataset.phone,
            rfid: btn.dataset.rfid,
            member_type_id: btn.dataset.memberType,
            role: btn.dataset.role,
            is_active: btn.dataset.active,
          });
        });
      });

      if (saveMemberBtn) {
        saveMemberBtn.addEventListener('click', submitMemberForm);
      }

      if (saveMemberTypeBtn) {
        saveMemberTypeBtn.addEventListener('click', submitMemberTypeForm);
      }

      function searchMembers(query) {
        if (!query || query.length < 2) {
          memberSearchResults.style.display = 'none';
          return;
        }

        fetch(`/api/search-members/?q=${encodeURIComponent(query)}`, {
          method: 'GET',
          headers: {
            'X-CSRFToken': csrftoken
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success && data.members && data.members.length > 0) {
            memberResultsList.innerHTML = '';
            data.members.forEach(member => {
              const item = document.createElement('a');
              item.href = '#';
              item.className = 'list-group-item list-group-item-action';
              item.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                  <div>
                    <h6 class="mb-1">${member.name}</h6>
                    <small class="text-muted">RFID: ${member.rfid} | Email: ${member.email || 'N/A'}</small>
                  </div>
                  <div class="text-end">
                    <small class="text-success fw-bold">₱${parseFloat(member.current_balance).toFixed(2)}</small>
                  </div>
                </div>
              `;
              item.addEventListener('click', (e) => {
                e.preventDefault();
                selectMember(member);
              });
              memberResultsList.appendChild(item);
            });
            memberSearchResults.style.display = 'block';
          } else {
            memberResultsList.innerHTML = '<div class="list-group-item text-muted text-center">No members found</div>';
            memberSearchResults.style.display = 'block';
          }
        })
        .catch(err => {
          console.error('Search error:', err);
          showAlert('Error searching members', 'danger');
        });
      }

      function selectMember(member) {
        selectedMember = member;
        selectedMemberName.textContent = member.name;
        selectedMemberRfid.textContent = member.rfid;
        selectedMemberBalance.textContent = `₱${parseFloat(member.current_balance).toFixed(2)}`;
        selectedMemberId.value = member.id;
        selectedMemberInfo.style.display = 'block';
        memberSearchResults.style.display = 'none';
        memberSearchInput.value = member.name;
        updateSubmitButton();
      }

      function updateSubmitButton() {
        const hasMember = selectedMember !== null;
        const hasAmount = refillAmount.value && parseFloat(refillAmount.value) > 0;
        submitRefillBtn.disabled = !(hasMember && hasAmount);
      }

      // Quick refill function
      window.quickRefill = function(memberId, memberName, memberRfid, currentBalance) {
        selectedMember = {
          id: memberId,
          name: memberName,
          rfid: memberRfid,
          current_balance: currentBalance.toString()
        };
        selectedMemberName.textContent = memberName;
        selectedMemberRfid.textContent = memberRfid;
        selectedMemberBalance.textContent = `₱${parseFloat(currentBalance).toFixed(2)}`;
        selectedMemberId.value = memberId;
        selectedMemberInfo.style.display = 'block';
        memberSearchInput.value = memberName;
        memberSearchResults.style.display = 'none';
        
        const modal = new bootstrap.Modal(refillBalanceModal);
        modal.show();
        updateSubmitButton();
      };

      // Search on input with debounce
      if (memberSearchInput) {
        memberSearchInput.addEventListener('input', (e) => {
          clearTimeout(searchTimeout);
          const query = e.target.value.trim();
          if (query.length >= 2) {
            searchTimeout = setTimeout(() => searchMembers(query), 300);
          } else {
            memberSearchResults.style.display = 'none';
            selectedMember = null;
            selectedMemberInfo.style.display = 'none';
            updateSubmitButton();
          }
        });
      }

      if (searchMemberBtn) {
        searchMemberBtn.addEventListener('click', () => {
          const query = memberSearchInput.value.trim();
          if (query.length >= 2) {
            searchMembers(query);
          }
        });
      }

      if (refillAmount) {
        refillAmount.addEventListener('input', updateSubmitButton);
      }

      // Handle form submission
      if (submitRefillBtn) {
        submitRefillBtn.addEventListener('click', () => {
          if (!selectedMember || !refillAmount.value) {
            showAlert('Please select a member and enter an amount', 'warning');
            return;
          }

          const amount = parseFloat(refillAmount.value);
          if (isNaN(amount) || amount <= 0) {
            showAlert('Please enter a valid amount greater than zero', 'warning');
            return;
          }

          submitRefillBtn.disabled = true;
          submitRefillBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Processing...';

          const payload = {
            member_id: selectedMember.id,
            amount: amount,
            notes: document.getElementById('refillNotes').value.trim()
          };

          fetch('/api/refill-balance/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(payload)
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              showAlert(data.message, 'success');
              // Reset form
              memberSearchInput.value = '';
              refillAmount.value = '';
              document.getElementById('refillNotes').value = '';
              selectedMember = null;
              selectedMemberInfo.style.display = 'none';
              memberSearchResults.style.display = 'none';
              
              // Reload page after 1.5 seconds to refresh data
              setTimeout(() => {
                window.location.reload();
              }, 1500);
            } else {
              showAlert(data.error || 'Failed to refill balance', 'danger');
              submitRefillBtn.disabled = false;
              submitRefillBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Refill Balance';
            }
          })
          .catch(err => {
            console.error('Refill error:', err);
            showAlert('Error processing balance refill', 'danger');
            submitRefillBtn.disabled = false;
            submitRefillBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Refill Balance';
          });
        });
      }

      // Reset form when modal is closed
      if (refillBalanceModal) {
        refillBalanceModal.addEventListener('hidden.bs.modal', () => {
          memberSearchInput.value = '';
          refillAmount.value = '';
          document.getElementById('refillNotes').value = '';
          selectedMember = null;
          selectedMemberInfo.style.display = 'none';
          memberSearchResults.style.display = 'none';
          refillAlert.style.display = 'none';
          submitRefillBtn.disabled = true;
          submitRefillBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Refill Balance';
        });
      }
    })();
  </script>
</body>
</html>

